<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rutas de Gestores</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    #map { height: 85vh; width: 100%; margin-top: 10px; }
    .filtros { margin-bottom: 8px; }
    .filtros label { margin-right: 15px; }
    #ultima-actualizacion { font-size: 12px; color: #333; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Mapa de Rutas de Gestores</h2>

  <div class="filtros">
    <label for="sucursalSelect">Sucursal:</label>
    <select id="sucursalSelect"></select>

    <label for="gestorSelect">Gestor:</label>
    <select id="gestorSelect"></select>

    <label for="fechaInput">Fecha:</label>
    <input type="text" id="fechaInput" placeholder="Selecciona una fecha">
    
    <div id="ultima-actualizacion"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const map = L.map("map", { zoomControl: false }).setView([19.4326, -99.1332], 12);
    L.control.zoom({ position: "bottomright" }).addTo(map);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "춸 OpenStreetMap contributors"
    }).addTo(map);

    let allData = [];
    let currentRoute = null;
    let currentMarkers = [];
    let calendario;

    const colores = ["blue", "red", "green", "purple", "orange", "brown"];
    const colorGestor = {};

    // 游늷 Cargar datos
    fetch("gestores.json").then(res => {
      const lastModified = res.headers.get("Last-Modified");
      if (lastModified) {
        const fecha = new Date(lastModified);
        document.getElementById("ultima-actualizacion").innerText =
          "칔ltima actualizaci칩n: " + fecha.toLocaleDateString("es-ES",
            { day: "numeric", month: "long", year: "numeric" });
      }
      return res.json();
    }).then(data => {
      allData = data;
      initFiltros();
    });

    function initFiltros() {
      const sucursales = [...new Set(allData.map(r => r.SUCURSAL))].sort();
      const sucursalSelect = document.getElementById("sucursalSelect");
      sucursalSelect.innerHTML = `<option value="">-- Selecciona --</option>`;
      sucursales.forEach(s => {
        let opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sucursalSelect.appendChild(opt);
      });

      sucursalSelect.addEventListener("change", actualizarGestores);
      document.getElementById("gestorSelect").addEventListener("change", actualizarFechas);

      calendario = flatpickr("#fechaInput", {
        dateFormat: "Y-m-d",
        disable: [],   // se llenar치 din치micamente
        onChange: function(selectedDates, dateStr) {
          if (dateStr) actualizarMapa(dateStr);
        }
      });
    }

    function actualizarGestores() {
      const sucursal = document.getElementById("sucursalSelect").value;
      const gestorSelect = document.getElementById("gestorSelect");
      gestorSelect.innerHTML = `<option value="">-- Selecciona --</option>`;
      
      if (!sucursal) return;

      const gestores = [...new Set(allData
        .filter(r => r.SUCURSAL === sucursal)
        .map(r => r.ASESOR))].sort();

      gestores.forEach((g, i) => {
        colorGestor[g] = colores[i % colores.length];
        let opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        gestorSelect.appendChild(opt);
      });
    }

    function actualizarFechas() {
      const sucursal = document.getElementById("sucursalSelect").value;
      const gestor = document.getElementById("gestorSelect").value;
      if (!sucursal || !gestor) return;

      const fechasDisponibles = [...new Set(allData
        .filter(r => r.SUCURSAL === sucursal && r.ASESOR === gestor)
        .map(r => r.FECHA_GESTION))].sort();

      // Bloquear todas las fechas excepto estas
      calendario.set("enable", fechasDisponibles);
      calendario.clear();
    }

    function crearIcono(numero, color) {
      return L.divIcon({
        className: 'mi-icono',
        html: `<div style="background:${color};color:white;
                          border-radius:50%;width:25px;height:25px;
                          display:flex;align-items:center;justify-content:center;
                          font-size:14px;font-weight:bold;">
                  ${numero}
               </div>`,
        iconSize: [25, 25]
      });
    }

    function actualizarMapa(fecha) {
      const sucursal = document.getElementById("sucursalSelect").value;
      const gestor = document.getElementById("gestorSelect").value;
      if (!sucursal || !gestor || !fecha) return;

      if (currentRoute) { map.removeLayer(currentRoute); currentRoute = null; }
      currentMarkers.forEach(m => map.removeLayer(m));
      currentMarkers = [];

      const registros = allData
        .filter(r => r.SUCURSAL === sucursal && r.ASESOR === gestor && r.FECHA_GESTION === fecha)
        .sort((a, b) => a.HORA.localeCompare(b.HORA));

      if (registros.length === 0) return;

      const coords = registros.map(r => [parseFloat(r.LATITUD), parseFloat(r.LONGITUD)]);
      const color = colorGestor[gestor] || "blue";

      currentRoute = L.polyline(coords, { color }).addTo(map);
      map.fitBounds(currentRoute.getBounds());

      registros.forEach((r, i) => {
        const icono = crearIcono(i + 1, color);
        const marker = L.marker([r.LATITUD, r.LONGITUD], { icon: icono })
          .bindPopup(`<b>${i + 1}. ${r.NOMBRE_COMPLETO}</b><br>
                      Hora: ${r.HORA}<br>
                      Acci칩n: ${r.ACCION}<br>
                      Sucursal: ${r.SUCURSAL}`);
        marker.addTo(map);
        currentMarkers.push(marker);
      });
    }
  </script>
</body>
</html>
