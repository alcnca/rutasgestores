<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matriz Horaria + Mapa (08:00‚Äì19:00)</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <style>
    :root{
      --grid-border:#cfd4da; --dot:#0d6efd; --empty:#ffd9d9; --empty-green:#d7f9cf; --off:#f5f6fa; --highlight:#fff0c2;
    }
    body{background:#fff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .smallnote{font-size:.9rem;color:#6c757d}

    /* Tabla de horario (matriz principal) */
    .table-grid th,.table-grid td{
      border:1px solid var(--grid-border);
      text-align:center;vertical-align:middle;
      padding:.25rem .35rem;
      font-size:.66rem; /* <<< CAMBIA AQU√ç EL TAMA√ëO de la MATRIZ si lo deseas */
    }
    .table-grid thead th{position:sticky;top:0;background:#fff;z-index:2;box-shadow:0 1px 0 0 var(--grid-border)}
    .nowrap{white-space:nowrap}
    .w-hour{min-width:2.4rem}
    .cell-dot{width:1.4rem;height:1.4rem;display:inline-flex;align-items:center;justify-content:center;margin:auto}
    .cell-dot::after{content:"";width:9px;height:9px;border-radius:50%;background:var(--dot);display:inline-block}
    .cell-empty::after{display:none}
    .cell-empty-wk{background:var(--empty); outline:1px solid #ffb3b3}
    .cell-empty-green{background:var(--empty-green)!important; outline:1px solid #b7f0c1!important}
    .cell-off{background:var(--off);color:#adb5bd}
    .badge-spot{background:#e7f1ff;color:#0d6efd;border:1px solid #b6d4fe}
    .scroll-x{overflow-x:auto}
    .col-highlight{background:var(--highlight)!important}

    /* Tablas peque√±as */
    #tblGaps, #tblSpots { font-size: .82rem; line-height: 1.25; }
    #tblGaps th, #tblGaps td, #tblSpots th, #tblSpots td { padding: .20rem .40rem; vertical-align: middle; }
    #tblGaps thead th, #tblSpots thead th { font-weight: 600; letter-spacing: .2px; }
    #tblGaps td.mono, #tblSpots td.mono { font-size: .78rem; }

    /* Gestiones diarias ‚Äî 4 columnas, letra peque√±a y en negritas */
    .daily-card table {
      font-size: .70rem; /* <<< CAMBIA AQU√ç EL TAMA√ëO de ‚ÄúGestiones diarias‚Äù */
    }
    .daily-card th, .daily-card td {
      padding: .20rem .32rem;
      font-weight: 700; /* <<< Cambia a 600/500 si no quieres tan negrita */
    }
    .daily-card tbody tr { cursor:pointer; }
    .daily-card tbody tr:hover { background:#f1f3f5; }
    .daily-card td:first-child { text-align: left; }     /* FECHA */
    .daily-card td:nth-child(2),
    .daily-card td:nth-child(3) { text-align: center; }  /* GESTIONES / SIN EVID. */

    /* KPIs lineales */
    .kpi-bar .badge{font-size:.88rem;padding:.45rem .6rem}

    /* Mapa */
    #map { height: 58vh; width: 100%; }
    .mi-icono div{
      border:2px solid rgba(255,255,255,.9);
      box-shadow:0 0 0 1px rgba(0,0,0,.15);
    }
    @media (max-width: 991px){
      #map{height:52vh}
    }

    /* Mensajes vac√≠os/errores */
    .empty-note{ color:#6c757d; font-size:.9rem; }
    .error-note{ color:#b02a37; font-weight:600; }

    /* SOCIOS SIN EVIDENCIAS (debajo del mapa) */
    #noEvWrap h2 { font-size: .95rem; }
    #tblNoEv { font-size: .76rem; } /* <<< CAMBIA AQU√ç el tama√±o de la tabla de ‚Äúsin evidencias‚Äù */
    #tblNoEv th, #tblNoEv td { vertical-align: middle; }
  </style>
</head>
<body>
  <main class="container py-3">
    <header class="mb-3">
      <h1 class="h4 mb-1">Seguimiento de Gestores - Acreimex -</h1>
      <p class="smallnote mb-0">
        Reporte muestra actividad de L-V 08:00‚Äì19:00 y S√°b 08:00‚Äì15:00.<br>
        Proceso (laboral): L‚ÄìV 09:00‚Äì18:00 (sin 14:00) y S√°b 09:00‚Äì14:00.
      </p>
    </header>

    <!-- CONTROLES -->
    <section class="card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">Usuario</label>
            <select id="userSelect" class="form-select"><option value="">(Selecciona)</option></select>
          </div>
          <div class="col-12 col-md-4 col-lg-3">
            <label class="form-label">Sucursal</label>
            <select id="fltSucursal" class="form-select"><option value="">(Todas)</option></select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Fecha desde</label>
            <input id="fltDesde" type="date" class="form-control" />
          </div>
          <div class="col-6 col-md-3 col-lg-2">
            <label class="form-label">Fecha hasta</label>
            <input id="fltHasta" type="date" class="form-control" />
          </div>
          <div class="col-12 col-lg-4 d-grid d-md-flex gap-2">
            <button id="btnRender" class="btn btn-success flex-fill">Generar Reporte</button>
          </div>
        </div>
        <div id="loadMsg" class="mt-2 empty-note"></div>
      </div>
    </section>

    <!-- MATRIZ + META -->
    <section class="mb-3">
      <div id="metaBar" class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <span class="badge rounded-pill text-bg-secondary" id="badgeRows">0 GESTIONES</span>
        </div>
      </div>
      <div class="scroll-x">
        <table id="grid" class="table table-grid table-sm">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mt-2">
        <span class="badge rounded-pill text-bg-secondary" id="badgeGroups">0 combinaciones (usuario+fecha)</span>
      </div>
    </section>

    <!-- KPIs LINEALES -->
    <section class="card mb-3">
      <div class="card-body kpi-bar d-flex flex-wrap gap-2">
        <span class="badge rounded-pill text-bg-primary">Total: <span id="kpiTotal">0</span></span>
        <span class="badge rounded-pill text-bg-secondary">D√≠as laborables (L‚ÄìV): <span id="kpiDias">0</span></span>
        <span class="badge rounded-pill text-bg-success">Promedio/d√≠a: <span id="kpiProm">0.00</span></span>
      </div>
    </section>

    <!-- Gestiones diarias ‚Äî 4 columnas -->
    <section class="mb-3">
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">
        <!-- A -->
        <div class="col">
          <div class="card h-100 daily-card">
            <div class="card-body">
              <div class="scroll-x">
                <table id="tblDailyA" class="table table-sm table-striped mb-0">
                  <thead><tr><th>FECHA</th><th>GESTIONES</th><th>SIN EVID.</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- B -->
        <div class="col">
          <div class="card h-100 daily-card">
            <div class="card-body">
              <div class="scroll-x">
                <table id="tblDailyB" class="table table-sm table-striped mb-0">
                  <thead><tr><th>FECHA</th><th>GESTIONES</th><th>SIN EVID.</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- C -->
        <div class="col">
          <div class="card h-100 daily-card">
            <div class="card-body">
              <div class="scroll-x">
                <table id="tblDailyC" class="table table-sm table-striped mb-0">
                  <thead><tr><th>FECHA</th><th>GESTIONES</th><th>SIN EVID.</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- D -->
        <div class="col">
          <div class="card h-100 daily-card">
            <div class="card-body">
              <div class="scroll-x">
                <table id="tblDailyD" class="table table-sm table-striped mb-0">
                  <thead><tr><th>FECHA</th><th>GESTIONES</th><th>SIN EVID.</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
       </div>
      </div>
    </section>

    <!-- MAPA + Socios sin evidencias -->
    <section class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <button class="btn btn-outline-primary btn-sm d-lg-none" type="button"
                  data-bs-toggle="collapse" data-bs-target="#mapCollapse"
                  aria-expanded="false" aria-controls="mapCollapse" id="btnToggleMap">
            Mostrar mapa
          </button>
        </div>

        <div id="mapCollapse" class="collapse mt-2">
          <div id="map"></div>
        </div>

        <!-- Tabla debajo del mapa -->
        <div id="noEvWrap" class="mt-3">
          <h2 class="h6 mb-2">
            Socios gestionados <span class="text-danger">sin evidencias</span>
            <span id="noEvCount" class="badge text-bg-danger ms-1">0</span>
          </h2>
          <div class="scroll-x">
            <table id="tblNoEv" class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Socio</th>
                  <th>Hora</th>
                  <th>Acci√≥n</th>
                  <th>Status</th>
                  <th>Mapa</th> <!-- <<<< AQU√ç: reemplaza Lat/Lon por Mapa -->
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="noEvEmpty" class="empty-note"></div>
        </div>
      </div>
    </section>

    <!-- Vac√≠os y Lugares repetidos -->
    <section class="row g-3">
      <div class="col-lg-7">
        <div class="card h-100">
          <div class="card-body">
            <h2 class="h6 mb-3">INACTIVIDAD</h2>
            <div class="scroll-x">
              <table id="tblGaps" class="table table-sm table-striped">
                <thead><tr><th>USUARIO</th><th>FECHA</th><th> Numero Hrs Inactivas</th><th>Horas sin Actividad</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="card h-100">
          <div class="card-body">
            <h2 class="h6 mb-3">Gestiones Realizadas en un Mismo Lugar</h2>
            <div class="scroll-x">
              <table id="tblSpots" class="table table-sm table-striped">
                <thead><tr><th>USUARIO</th><th>LAT_RED</th><th>LON_RED</th><th>Gestiones</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // ===== Config =====
  const JSON_URLS = [
    "https://raw.githubusercontent.com/alcnca/rutasgestores/main/gestores.json",
    "https://raw.githubusercontent.com/alcnca/rutasgestores/refs/heads/main/gestores.json" // fallback
  ];
  const HOUR_START = 8;  // vista
  const HOUR_END   = 19; // vista
  const HOURS = Array.from({length: HOUR_END - HOUR_START + 1}, (_, i) => HOUR_START + i);

  // ===== Utils =====
  const uniq = arr => Array.from(new Set(arr));
  const by = (a,b) => (a||"").toString().localeCompare((b||"").toString(),'es');
  const pad2 = n => String(n).padStart(2,'0');
  const hourLabel = h => `${pad2(h)}:00`;
  const normalizeHourStr = s => (s||'')
      .replace(/\s+/g,' ')
      .replace('a. m.','AM').replace('p. m.','PM')
      .replace('a. m','AM').replace('p. m','PM')
      .trim();
  function parseTimeToHourBase(str){
    if(!str) return null; const s = normalizeHourStr(str).toUpperCase();
    const m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?$/); if(!m) return null;
    let hh = parseInt(m[1],10); const ap = m[4]||null;
    if(ap){ if(ap==='AM'){ if(hh===12) hh=0; } else { if(hh!==12) hh+=12; } }
    return (hh>=0&&hh<=23)? hh : null;
  }
  function toISODate(dstr){
    if(!dstr) return '';
    const s = (dstr+'').trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m) return `${m[3]}-${m[2]}-${m[1]}`;
    const d = new Date(s); if(Number.isNaN(d.getTime())) return '';
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  const roundCoord = (v,dec)=>{ const num = Number(v); if(Number.isNaN(num)) return null; const p=Math.pow(10,dec); return Math.round(num*p)/p; };
  const dowOfISO = iso => new Date(iso+'T00:00:00').getDay();

  // ===== Evidencia (a partir de STATUS) =====
  function isNoEvidenceStatus(statusRaw){
    const s = (statusRaw || '').toString().trim().toUpperCase();
    if(!s) return true; // vac√≠o = sin evidencia
    if (s === 'SIN EVIDENCIA' || s === 'SIN EVIDENCIAS') return true;
    if (s === 'NO' || s === 'N/A' || s === 'NA' || s === 'PENDIENTE') return true;
    if (/^NO\b/.test(s)) return true;
    if (/SIN\s+EVIDEN/.test(s)) return true;
    return false;
  }
  function accionCuentaComoEvidencia(accionRaw){
    const a = (accionRaw || '').toString().trim().toUpperCase();
    return (a.includes('ALTA') && a.includes('DIGI')); // "ALTA DIGITALIZACION"
  }
  function hasEvidence(row){
    if (accionCuentaComoEvidencia(row['ACCION'])) return true;
    return !isNoEvidenceStatus(row['STATUS']);
  }

  // Horarios
  function workHoursForDate(iso){
    const dow = dowOfISO(iso); const set = new Set();
    if (dow >= 1 && dow <= 5) { for (let h = 9; h <= 18; h++) if(h!==14) set.add(h); }
    else if (dow === 6) { for (let h = 9; h <= 14; h++) set.add(h); }
    return set;
  }
  function countHoursForDate(iso){
    const dow = dowOfISO(iso); const set = new Set();
    if (dow >= 1 && dow <= 5) { for (let h = 9; h <= 17; h++) if(h!==14) set.add(h); }
    else if (dow === 6) { for (let h = 9; h <= 14; h++) set.add(h); }
    return set;
  }
  function countWorkdays(fromISO, toISO){
    if(!fromISO || !toISO) return 0;
    const d = new Date(fromISO + 'T00:00:00'); const end = new Date(toISO + 'T00:00:00'); let c = 0;
    while(d <= end){ const dow = d.getDay(); if(dow >= 1 && dow <= 5) c++; d.setDate(d.getDate()+1); }
    return c;
  }

  // ===== Estado =====
  let rawRows = [];
  const getUserField = r => (r['ASESOR']||r['GESTOR']||r['USUARIO']||'').toString().trim();

  // ====== MAPA ======
  let map, currentRoute=null, currentMarkers=[];
  const color = "blue";
  function crearIcono(numero, color) {
    return L.divIcon({
      className: 'mi-icono',
      html: `<div style="background:${color};color:white;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;">${numero}</div>`,
      iconSize: [26, 26]
    });
  }

  // ====== Carga de datos (con fallback) ======
  async function loadRemoteJson(){
    const loadMsg = document.getElementById('loadMsg');
    loadMsg.textContent = 'Cargando JSON‚Ä¶';
    let lastErr = null;

    for(const url of JSON_URLS){
      try{
        const res = await fetch(`${url}?t=${Date.now()}`, {mode:'cors', cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const norm=o=>{const n={}; for(const k of Object.keys(o)){ n[k.toUpperCase()]=o[k]; } return n; };
        rawRows = (Array.isArray(data)?data:(data?.rows||[])).map(norm);

        if(!Array.isArray(rawRows) || rawRows.length===0){
          console.warn('JSON cargado pero vac√≠o desde:', url, data);
          continue; // prueba el siguiente URL
        }

        // Usuarios
        const users = uniq(rawRows.map(getUserField).filter(Boolean)).sort(by);
        const userSel = document.getElementById('userSelect');
        userSel.innerHTML = users.length
          ? '<option value="">(Selecciona)</option>' + users.map(v=>`<option>${v}</option>`).join('')
          : '<option value="">(Sin usuarios)</option>';

        document.getElementById('fltSucursal').innerHTML = '<option value="">(Todas)</option>';

        loadMsg.textContent = `JSON cargado (${rawRows.length} filas)`;
        return; // √©xito
      }catch(err){
        console.error('Fallo cargando', url, err);
        lastErr = err;
      }
    }

    // Si llega aqu√≠, fallaron ambas rutas
    loadMsg.innerHTML = `<span class="error-note">No se pudo cargar el JSON remoto.</span> Revisa que el archivo exista y sea p√∫blico.`;
    rawRows = [];
  }

  // ========= Auxiliares de filtros =========
  function sucursalesForUser(user){
    return uniq(rawRows.filter(r=> getUserField(r)===user)
                      .map(r=> (r['SUCURSAL']||'').toString().trim())
                      .filter(Boolean)).sort(by);
  }

  // ========= Render Matriz & KPI =========
  function buildMatrix(){
    const user=document.getElementById('userSelect').value;
    const suc=document.getElementById('fltSucursal').value;
    const desde=document.getElementById('fltDesde').value;
    const hasta=document.getElementById('fltHasta').value;
    const dec=5;

    if(!rawRows.length){
      document.getElementById('badgeRows').textContent = `0 Gestiones`;
      document.querySelector('#grid thead').innerHTML = '';
      document.querySelector('#grid tbody').innerHTML = '';
      ['#tblDailyA','#tblDailyB','#tblDailyC','#tblDailyD','#tblGaps','#tblSpots'].forEach(sel=>{
        const tb=document.querySelector(`${sel} tbody`); if(tb) tb.innerHTML='';
      });
      return;
    }

    const pre = rawRows.map(r=>{
      const horaSrc=(r['HORA2']&&r['HORA2'].toString().trim()!=='')? r['HORA2'] : r['HORA'];
      const hourBase=parseTimeToHourBase(horaSrc);
      const fechaISO=toISODate(r['FECHA_GESTION']||r['FECHA']||'');
      const latr=roundCoord(r['LATITUD'],dec);
      const lonr=roundCoord(r['LONGITUD'],dec);
      const usuario=getUserField(r);
      return {...r,_usuario:usuario,_fecha:fechaISO,_hourBase:hourBase,_lat_r:latr,_lon_r:lonr,_spotKey:`${usuario}|${latr},${lonr}`};
    }).filter(r=> r._fecha && r._usuario);

    const rowsF = pre.filter(r=>
      (!user||r._usuario===user) &&
      (!suc||(r['SUCURSAL']||'').toString().trim()===suc) &&
      (!desde||r._fecha>=desde) &&
      (!hasta||r._fecha<=hasta)
    );

    document.getElementById('badgeRows').textContent = `${rowsF.length} Gestiones`;

    const mapG=new Map();
    for(const r of rowsF){
      if(r._hourBase==null) continue;
      const k=`${r._usuario}|${r._fecha}`;
      if(!mapG.has(k)) mapG.set(k,{usuario:r._usuario,fecha:r._fecha,hours:new Set(),rows:[]});
      const g=mapG.get(k);
      g.hours.add(r._hourBase);
      g.rows.push(r);
    }
    const groups=Array.from(mapG.values()).sort((a,b)=> by(a.usuario,b.usuario)||by(a.fecha,b.fecha));
    document.getElementById('badgeGroups').textContent = `${groups.length} Dias Con Gestiones`;

    // ===== KPIs + diario (con SIN EVID.) =====
    const dailyMap = new Map();
    for (const r of rowsF){
      const d = r._fecha;
      const obj = dailyMap.get(d) || { total: 0, noEv: 0 };
      obj.total += 1;
      if (!hasEvidence(r)) obj.noEv += 1;
      dailyMap.set(d, obj);
    }

    const totalGest=rowsF.length;
    const workdays=countWorkdays(desde,hasta);
    const avg=workdays? totalGest/workdays : 0;
    document.getElementById('kpiTotal').textContent=totalGest;
    document.getElementById('kpiDias').textContent=workdays;
    document.getElementById('kpiProm').textContent=avg.toFixed(2);

    const entries = Array.from(dailyMap.entries()).sort((a,b)=>a[0].localeCompare(b[0]));

    // 4 columnas
    const DAILY_COLS = 4;
    const size = Math.ceil(entries.length / DAILY_COLS);
    const chunk = (arr, s, i)=> arr.slice(i*s, (i+1)*s);

    const cols = [
      chunk(entries, size, 0),
      chunk(entries, size, 1),
      chunk(entries, size, 2),
      chunk(entries, size, 3),
    ];

    const tbs = [
      document.querySelector('#tblDailyA tbody'),
      document.querySelector('#tblDailyB tbody'),
      document.querySelector('#tblDailyC tbody'),
      document.querySelector('#tblDailyD tbody'),
    ];
    tbs.forEach(tb=> tb && (tb.innerHTML=''));

    const rowTpl = ([fecha,obj]) => `<tr data-fecha="${fecha}"><td>${fecha}</td><td>${obj.total}</td><td>${obj.noEv}</td></tr>`;
    cols.forEach((c,idx)=> c.forEach(e=> tbs[idx] && tbs[idx].insertAdjacentHTML('beforeend', rowTpl(e))));

    // same spot count
    const spotCount=new Map(); for(const r of rowsF){ const k=r._spotKey; spotCount.set(k,(spotCount.get(k)||0)+1); }

    // header de la matriz horaria
    const thead=document.querySelector('#grid thead'); const tbody=document.querySelector('#grid tbody');
    thead.innerHTML=''; tbody.innerHTML='';
    const trh=document.createElement('tr');
    ['USUARIO','FECHA','MISMO LUGAR'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
    for(const h of HOURS){
      const thEl=document.createElement('th'); thEl.className='w-hour nowrap'; thEl.textContent=`${pad2(h)}:00`; thEl.dataset.hour=h; thEl.style.cursor='pointer'; trh.appendChild(thEl);
    }
    thead.appendChild(trh);

    // cuerpo
    const gapsRows=[];
    for(const g of groups){
      const tr=document.createElement('tr');
      tr.appendChild(Object.assign(document.createElement('td'),{textContent:g.usuario}));
      tr.appendChild(Object.assign(document.createElement('td'),{textContent:g.fecha}));
      const uniqSpots=uniq(g.rows.map(r=>`${r._lat_r},${r._lon_r}`));
      const repeated=uniqSpots.filter(s=> spotCount.get(`${g.usuario}|${s}`)>1);
      const tdS=document.createElement('td'); tdS.innerHTML=`<span class="badge rounded-pill badge-spot">${repeated.length} repetidos</span>`; tr.appendChild(tdS);

      const wkSet  = workHoursForDate(g.fecha);
      const cntSet = countHoursForDate(g.fecha);
      const emptiesVisual = HOURS.filter(h => wkSet.has(h) && !g.hours.has(h));

      let greenHour=null; const dow=dowOfISO(g.fecha);
      if(dow>=1&&dow<=5&&emptiesVisual.length){
        greenHour=emptiesVisual.reduce((best,h)=>{
          if(best===null) return h;
          const da=Math.abs(h-14), db=Math.abs(best-14);
          if(da<db) return h; if(da>db) return best;
          return (h<best)?h:best;
        }, null);
      }

      for(const h of HOURS){
        const td=document.createElement('td'); td.className='w-hour';
        const has=g.hours.has(h); const off=!wkSet.has(h);
        if(off){
          if(has){ td.classList.add('cell-off'); td.innerHTML='<span class="cell-dot"></span>'; }
          else { td.classList.add('cell-off'); td.textContent='‚Äî'; }
        } else if(has){
          td.innerHTML='<span class="cell-dot"></span>';
        } else {
          if(h===greenHour) td.classList.add('cell-empty-green');
          else td.classList.add('cell-empty-wk');
          td.innerHTML='<span class="cell-dot cell-empty"></span>';
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);

      // Vac√≠os REPORTE (conteo)
      const emptiesReportHours = HOURS.filter(h => cntSet.has(h) && !g.hours.has(h));
      gapsRows.push({usuario:g.usuario,fecha:g.fecha,count:emptiesReportHours.length,list:emptiesReportHours.map(hourLabel).join(', ')});
    }

    // click en hora para resaltar columna
    thead.querySelectorAll('th[data-hour]').forEach(th=>{
      th.addEventListener('click',()=>{
        const hour=Number(th.dataset.hour);
        const offset=(hour-HOUR_START)+3;
        tbody.querySelectorAll('tr').forEach(tr=>{
          tr.querySelectorAll('td').forEach((td,idx)=>{
            td.classList.toggle('col-highlight', idx===offset);
          });
        });
      });
    });

    // gaps table
    const gapsTbody=document.querySelector('#tblGaps tbody'); gapsTbody.innerHTML='';
    for(const g of gapsRows.sort((a,b)=> by(a.usuario,b.usuario)||by(a.fecha,b.fecha))){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${g.usuario}</td><td>${g.fecha}</td><td>${g.count}</td><td class="mono">${g.list}</td>`;
      gapsTbody.appendChild(tr);
    }

    // spots table
    const tblSpots=document.querySelector('#tblSpots tbody'); tblSpots.innerHTML='';
    const byUserSpots=new Map();
    for(const r of rowsF){
      const [usuario,spot]=r._spotKey.split('|');
      if(!byUserSpots.has(usuario)) byUserSpots.set(usuario,new Map());
      const m=byUserSpots.get(usuario);
      m.set(spot,(m.get(spot)||0)+1);
    }
    for(const u of Array.from(byUserSpots.keys()).sort(by)){
      const m=byUserSpots.get(u);
      for(const [spot,c] of Array.from(m.entries()).sort((x,y)=>y[1]-x[1])){
        const [lat,lon]=spot.split(',');
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${u}</td><td class="mono">${lat}</td><td class="mono">${lon}</td><td>${c}</td>`;
        tblSpots.appendChild(tr);
      }
    }

    // CLICK EN GESTIONES DIARIAS -> actualizar mapa + sin evidencias
    const onDailyClick = (ev)=>{
      const tr = ev.target.closest('tr');
      if(!tr || !tr.dataset.fecha) return;
      actualizarMapa(tr.dataset.fecha);
    };
    ['#tblDailyA','#tblDailyB','#tblDailyC','#tblDailyD'].forEach(sel=>{
      document.querySelectorAll(`${sel} tbody tr`).forEach(tr=> tr.addEventListener('click', onDailyClick));
    });

    // Render inicial del mapa con la primera fecha (si existe)
    if (entries.length) actualizarMapa(entries[0][0]);
  }

  // ========= MAPA + ‚ÄúSIN EVIDENCIAS‚Äù =========
  function actualizarMapa(fecha){
    const suc = document.getElementById("fltSucursal").value;
    const user = document.getElementById("userSelect").value;
    if(!user || !fecha) return;

    // Limpia capa previa
    if (currentRoute) { map.removeLayer(currentRoute); currentRoute = null; }
    currentMarkers.forEach(m => map.removeLayer(m));
    currentMarkers = [];

    // Filtra registros v√°lidos con coords num√©ricas
    const registros = rawRows
      .filter(r => getUserField(r)===user &&
                   (!suc || (r['SUCURSAL']||'').toString().trim()===suc) &&
                   toISODate(r['FECHA_GESTION']||r['FECHA']||'') === fecha)
      .map(r => ({...r,
        _lat: Number(r.LATITUD),
        _lon: Number(r.LONGITUD),
        _h: normalizeHourStr((r['HORA2']||r['HORA']||'')+'' )
      }))
      .filter(r => Number.isFinite(r._lat) && Number.isFinite(r._lon))
      .sort((a,b) => a._h.localeCompare(b._h));

    // === MAPA ===
    if(registros.length){
      const coords = registros.map(r => [r._lat, r._lon]);

      if(!map){
        map = L.map("map", { zoomControl: false }).setView(coords[0], 12);
        L.control.zoom({ position: "bottomright" }).addTo(map);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap contributors" }).addTo(map);
        // abrir mapa por defecto en desktop
        const collEl = document.getElementById('mapCollapse');
        const coll = new bootstrap.Collapse(collEl, { toggle:false });
        if (window.innerWidth >= 992) coll.show();
        setTimeout(()=> map.invalidateSize(), 150);
      }else{
        map.setView(coords[0], 12, {animate:true});
      }

      currentRoute = L.polyline(coords, { color }).addTo(map);
      setTimeout(()=>{ map.flyToBounds(currentRoute.getBounds(), {padding:[40,40], duration:.7}); }, 150);

      registros.forEach((r,i)=>{
        const icono = crearIcono(i+1, color);
        const marker = L.marker([r._lat, r._lon], {icon:icono})
          .bindPopup(`<b>${i+1}. ${(r.NOMBRE_COMPLETO||'').toString()}</b><br>
                      Hora: ${(r.HORA2||r.HORA||'').toString()}<br>
                      Acci√≥n: ${(r.ACCION||'').toString()}<br>
                      Sucursal: ${(r.SUCURSAL||'').toString()}<br>
                      Status: ${(r.STATUS||'').toString()}`);
        marker.addTo(map);
        currentMarkers.push(marker);
      });
    }

    // === TABLA ‚ÄúSIN EVIDENCIAS‚Äù (debajo del mapa) ===
    const noEvBody = document.querySelector('#tblNoEv tbody');
    const noEvEmpty = document.getElementById('noEvEmpty');
    const noEvCount = document.getElementById('noEvCount');
    noEvBody.innerHTML = '';
    noEvEmpty.textContent = '';

    const registrosSinEv = registros.filter(r => !hasEvidence(r));
    noEvCount.textContent = registrosSinEv.length;

    if(!registros.length){
      noEvEmpty.textContent = 'No hay gestiones para la fecha seleccionada.';
      return;
    }
    if(registrosSinEv.length === 0){
      noEvEmpty.textContent = 'No hay registros sin evidencias para esta fecha.';
      return;
    }

    // Utilidad para armar el link a Google Maps
    const mapsHref = (lat, lon) => `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lon)}`;

    // Fila con icono/bot√≥n que abre Google Maps
    const fila = (i, r) => `
      <tr>
        <td>${i+1}</td>
        <td>${(r.NOMBRE_COMPLETO||'').toString()}</td>
        <td>${(r.HORA2||r.HORA||'').toString()}</td>
        <td>${(r.ACCION||'').toString()}</td>
        <td>${(r.STATUS||'').toString()}</td>
        <td>
          ${
            (Number.isFinite(r._lat) && Number.isFinite(r._lon))
            ? `<a href="${mapsHref(r._lat, r._lon)}" target="_blank" rel="noopener"
                  class="btn btn-sm btn-outline-primary rounded-circle d-inline-flex align-items-center justify-content-center"
                  style="width:28px;height:28px" title="Abrir en Google Maps">üìç</a>`
            : `<span class="text-muted">‚Äî</span>`
          }
        </td>
      </tr>
    `;
    registrosSinEv.forEach((r,i)=> noEvBody.insertAdjacentHTML('beforeend', fila(i,r)));
  }

  // ===== Eventos =====
  document.getElementById('userSelect').addEventListener('change', ()=>{
    const user=document.getElementById('userSelect').value;
    const sucs=user? sucursalesForUser(user) : [];
    const sel=document.getElementById('fltSucursal');
    sel.innerHTML='<option value="">(Todas)</option>'+sucs.map(v=>`<option>${v}</option>`).join('');
  });
  document.getElementById('btnRender').addEventListener('click', buildMatrix);

  // Invalidate Leaflet cuando el collapse se muestra/oculta (en m√≥vil)
  document.addEventListener('shown.bs.collapse', (ev)=>{
    if(ev.target.id === 'mapCollapse' && typeof map?.invalidateSize === 'function'){
      setTimeout(()=> map.invalidateSize(), 150);
    }
    if(ev.target.id === 'mapCollapse'){
      document.getElementById('btnToggleMap').innerText = 'Ocultar mapa';
    }
  });
  document.addEventListener('hidden.bs.collapse', (ev)=>{
    if(ev.target.id === 'mapCollapse'){
      document.getElementById('btnToggleMap').innerText = 'Mostrar mapa';
    }
  });

  // ===== Init =====
  document.addEventListener('DOMContentLoaded', async ()=>{
    // collapse mapa: abierto en ‚â•lg, cerrado en <lg
    const mapCollEl = document.getElementById('mapCollapse');
    const mapColl = new bootstrap.Collapse(mapCollEl, { toggle:false });
    if (window.innerWidth >= 992) mapColl.show(); else mapColl.hide();

    // fechas por defecto
    const t=new Date(); const yyyy=t.getFullYear(); const mm=pad2(t.getMonth()+1); const dd=pad2(t.getDate());
    document.getElementById('fltDesde').value=`${yyyy}-${mm}-01`;
    document.getElementById('fltHasta').value=`${yyyy}-${mm}-${dd}`;

    await loadRemoteJson();

    const userSel=document.getElementById('userSelect');
    if(userSel.options.length>1){
      userSel.selectedIndex=1; // selecciona el primer usuario real
      const user=userSel.value;
      const sucs=user? sucursalesForUser(user):[];
      const sel=document.getElementById('fltSucursal');
      sel.innerHTML='<option value="">(Todas)</option>'+sucs.map(v=>`<option>${v}</option>`).join('');
    }

    buildMatrix();
  });
</script>

</body>
</html>
