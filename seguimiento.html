<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Rutas de Gestores</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; }
    .selector { margin: 10px; }
  </style>
</head>
<body>
  <div class="selector">
    <label for="asesor">Gestor:</label>
    <select id="asesor"></select>

    <label for="fecha">Fecha:</label>
    <input type="date" id="fecha">
    <button onclick="filtrar()">Mostrar ruta</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let mapa = L.map('map').setView([21.16, -89.65], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(mapa);

    let datos = [];
    let capaRuta;

    // Cargar archivo JSON (tu archivo se llama gestores.json)
    fetch("gestores.json")
      .then(res => res.json())
      .then(json => {
        datos = json;

        // Poblar lista de asesores Ãºnicos
        let asesores = [...new Set(datos.map(d => d.ASESOR))];
        let sel = document.getElementById("asesor");
        asesores.forEach(a => {
          let opt = document.createElement("option");
          opt.value = a; opt.textContent = a;
          sel.appendChild(opt);
        });
      });

    function filtrar() {
      if (capaRuta) {
        mapa.removeLayer(capaRuta);
      }

      let asesor = document.getElementById("asesor").value;
      let fecha = document.getElementById("fecha").value;

      // Filtrar por asesor y FECHA_GESTION (columna 11 en tu Excel)
      let puntos = datos.filter(d => d.ASESOR === asesor && d.FECHA_GESTION === fecha);

      // Ordenar por HORA (columna 12 en tu Excel)
      puntos.sort((a, b) => a.HORA.localeCompare(b.HORA));

      let coords = puntos.map(d => [parseFloat(d.LATITUD), parseFloat(d.LONGITUD)]);

      if (coords.length === 0) {
        alert("No hay registros para este gestor en esa fecha");
        return;
      }

      // Dibujar la ruta
      capaRuta = L.polyline(coords, {color: 'blue'}).addTo(mapa);
      mapa.fitBounds(capaRuta.getBounds());

      // Agregar marcadores numerados en orden por hora
      puntos.forEach((d, i) => {
        let numero = i + 1; // empieza en 1
        let icono = L.divIcon({
          className: 'mi-icono',
          html: `<div style="background:#007bff;color:white;
                            border-radius:50%;width:25px;height:25px;
                            display:flex;align-items:center;justify-content:center;
                            font-size:14px;font-weight:bold;">
                    ${numero}
                 </div>`,
          iconSize: [25, 25]
        });

        L.marker([d.LATITUD, d.LONGITUD], {icon: icono})
          .bindPopup(`<b>${numero}. ${d.NOMBRE_COMPLETO || d.NOMBRE}</b><br>
                      ${d.HORA}<br>
                      ${d.ACCION}`)
          .addTo(mapa);
      });
    }
  </script>
</body>
</html>
