<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rutas de Gestores</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    #map { height: 90vh; width: 100%; }
    .info-panel {
      margin: 10px 0;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>Mapa de Rutas de Gestores</h2>

  <label for="gestorSelect">Gestor:</label>
  <select id="gestorSelect"></select>

  <label for="sucursalSelect">Sucursal:</label>
  <select id="sucursalSelect">
    <option value="TODAS">Todas</option>
  </select>

  <label for="fechaInput">Fecha:</label>
  <input type="date" id="fechaInput">

  <button id="mostrarRuta">Mostrar ruta</button>

  <div class="info-panel">
    <span id="ultima-actualizacion"></span>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Mapa con controles de zoom en la esquina inferior derecha
    const map = L.map("map", { zoomControl: false }).setView([19.4326, -99.1332], 12);
    L.control.zoom({ position: "bottomright" }).addTo(map);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    let currentRoute = null;
    let currentMarkers = [];

    // 🎨 Colores distintos por gestor
    const colores = ["blue", "red", "green", "purple", "orange", "brown"];
    const colorGestor = {};

    let dataGlobal = [];

    // Cargar JSON y llenar selects
    fetch("gestores.json")
      .then(res => {
        // 🔹 Mostrar fecha de última modificación
        const lastModified = res.headers.get("Last-Modified");
        if (lastModified) {
          const fecha = new Date(lastModified);
          const fechaFormateada = fecha.toLocaleDateString("es-MX", {
            day: "numeric",
            month: "long",
            year: "numeric"
          });
          document.getElementById("ultima-actualizacion").textContent =
            "Última actualización: " + fechaFormateada;
        }
        return res.json();
      })
      .then(data => {
        dataGlobal = data;

        // Llenar gestores
        const gestores = [...new Set(data.map(r => r.ASESOR))];
        const selectGestor = document.getElementById("gestorSelect");
        gestores.forEach((g, i) => {
          colorGestor[g] = colores[i % colores.length];
          let opt = document.createElement("option");
          opt.value = g;
          opt.textContent = g;
          selectGestor.appendChild(opt);
        });

        // Llenar sucursales
        const sucursales = [...new Set(data.map(r => r.SUCURSAL))];
        const selectSuc = document.getElementById("sucursalSelect");
        sucursales.forEach(s => {
          let opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          selectSuc.appendChild(opt);
        });
      });

    // Función para crear icono numerado
    function crearIcono(numero, color) {
      return L.divIcon({
        className: 'mi-icono',
        html: `<div style="background:${color};color:white;
                          border-radius:50%;width:25px;height:25px;
                          display:flex;align-items:center;justify-content:center;
                          font-size:14px;font-weight:bold;">
                  ${numero}
               </div>`,
        iconSize: [25, 25]
      });
    }

    // Evento click para mostrar ruta
    document.getElementById("mostrarRuta").addEventListener("click", function () {
      const gestor = document.getElementById("gestorSelect").value;
      const sucursal = document.getElementById("sucursalSelect").value;
      const fecha = document.getElementById("fechaInput").value;

      // Limpiar rutas y marcadores anteriores
      if (currentRoute) {
        map.removeLayer(currentRoute);
        currentRoute = null;
      }
      currentMarkers.forEach(m => map.removeLayer(m));
      currentMarkers = [];

      const registros = dataGlobal
        .filter(r =>
          r.ASESOR === gestor &&
          r.FECHA_GESTION === fecha &&
          (sucursal === "TODAS" || r.SUCURSAL === sucursal)
        )
        .sort((a, b) => a.HORA.localeCompare(b.HORA));

      if (registros.length === 0) {
        alert("No hay registros para este gestor en esa fecha/sucursal");
        return;
      }

      const coords = registros.map(r => [parseFloat(r.LATITUD), parseFloat(r.LONGITUD)]);
      const color = colorGestor[gestor] || "blue";

      // Dibujar ruta
      currentRoute = L.polyline(coords, { color }).addTo(map);
      map.fitBounds(currentRoute.getBounds());

      // Agregar marcadores enumerados
      registros.forEach((r, i) => {
        const icono = crearIcono(i + 1, color);
        const marker = L.marker([r.LATITUD, r.LONGITUD], { icon: icono })
          .bindPopup(`<b>${i + 1}. ${r.NOMBRE_COMPLETO}</b><br>
                      Hora: ${r.HORA}<br>
                      Acción: ${r.ACCION}<br>
                      Sucursal: ${r.SUCURSAL}`);
        marker.addTo(map);
        currentMarkers.push(marker);
      });
    });
  </script>
</body>
</html>
